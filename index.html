<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>äº¬éƒ½æ¡‚ç—…é™¢ ç·å‹™èª² å•ã„åˆã‚ã›çª“å£</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- GIS ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root {
      --primary: #0f766e;
      --primary-light: #14b8a6;
      --accent: #f59e0b;
      --bg-gradient-1: #f0fdfa;
      --bg-gradient-2: #ecfdf5;
      --bg-gradient-3: #fff7ed;
      --text-primary: #134e4a;
      --text-secondary: #5f6d6a;
      --card-bg: rgba(255, 255, 255, 0.85);
      --border-color: rgba(15, 118, 110, 0.15);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Zen Maru Gothic", "Noto Sans JP", -apple-system, BlinkMacSystemFont, sans-serif;
      background: 
        radial-gradient(ellipse at 20% 0%, var(--bg-gradient-1) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, var(--bg-gradient-3) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, var(--bg-gradient-2) 0%, transparent 70%),
        linear-gradient(180deg, #fafafa 0%, #f5f5f5 100%);
      color: var(--text-primary);
      min-height: 100vh;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px 16px;
      position: relative;
      overflow: hidden;
    }

    body::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: 
        repeating-linear-gradient(
          45deg,
          transparent,
          transparent 40px,
          rgba(15, 118, 110, 0.02) 40px,
          rgba(15, 118, 110, 0.02) 80px
        );
      pointer-events: none;
    }

    .card {
      max-width: 520px;
      width: 100%;
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 1px solid var(--border-color);
      padding: 40px 36px 36px;
      box-shadow: 
        0 4px 6px -1px rgba(0, 0, 0, 0.05),
        0 20px 50px -12px rgba(15, 118, 110, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
      position: relative;
      animation: slideUp 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards;
      opacity: 0;
      transform: translateY(20px);
    }

    @keyframes slideUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--primary-light));
      border-radius: 0 0 4px 4px;
    }

    .header {
      text-align: center;
      margin-bottom: 28px;
    }

    .logo-icon {
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      animation: slideUp 0.6s cubic-bezier(0.22, 1, 0.36, 1) 0.1s forwards;
      opacity: 0;
    }

    .logo-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    h1 {
      font-size: 22px;
      margin: 0 0 6px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: 0.02em;
      animation: slideUp 0.6s cubic-bezier(0.22, 1, 0.36, 1) 0.15s forwards;
      opacity: 0;
    }

    .subtitle {
      font-size: 13px;
      color: var(--text-secondary);
      margin: 0;
      animation: slideUp 0.6s cubic-bezier(0.22, 1, 0.36, 1) 0.2s forwards;
      opacity: 0;
    }

    .description {
      font-size: 14px;
      line-height: 1.8;
      margin: 0;
      color: var(--text-secondary);
      text-align: center;
      animation: slideUp 0.6s cubic-bezier(0.22, 1, 0.36, 1) 0.25s forwards;
      opacity: 0;
    }

    .domain {
      font-family: "SF Mono", ui-monospace, "Cascadia Code", Menlo, Monaco, monospace;
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 6px;
      background: linear-gradient(135deg, rgba(15, 118, 110, 0.08), rgba(20, 184, 166, 0.08));
      border: 1px solid rgba(15, 118, 110, 0.15);
      color: var(--primary);
      font-weight: 500;
      white-space: nowrap;
    }

    #gsiArea {
      margin: 28px 0;
      display: flex;
      justify-content: center;
      animation: slideUp 0.6s cubic-bezier(0.22, 1, 0.36, 1) 0.3s forwards;
      opacity: 0;
    }

    .note {
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      border: 1px solid rgba(245, 158, 11, 0.2);
      border-radius: 12px;
      padding: 14px 16px;
      margin: 0;
      font-size: 12px;
      line-height: 1.7;
      color: #92400e;
      animation: slideUp 0.6s cubic-bezier(0.22, 1, 0.36, 1) 0.35s forwards;
      opacity: 0;
    }

    .note::before {
      content: 'ğŸ’¡';
      margin-right: 6px;
    }

    .note .domain {
      background: rgba(245, 158, 11, 0.15);
      border-color: rgba(245, 158, 11, 0.25);
      color: #b45309;
    }
  </style>
</head>
<body>
  <main class="card">
    <div class="header">
      <div class="logo-icon">
        <img src="img/katsura_logo.png" alt="äº¬éƒ½æ¡‚ç—…é™¢ãƒ­ã‚´">
      </div>
      <h1>äº¬éƒ½æ¡‚ç—…é™¢ ç·å‹™èª²</h1>
      <p class="subtitle">å•ã„åˆã‚ã›çª“å£ã‚·ã‚¹ãƒ†ãƒ </p>
    </div>

    <p class="description">
      ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ <span class="domain">@katsura.com</span> ã®<br>
      Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã®ã¿åˆ©ç”¨ã§ãã¾ã™ã€‚<br>
      ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã€äºˆç´„ç”»é¢ã¸é€²ã‚“ã§ãã ã•ã„ã€‚
    </p>

    <div id="gsiArea">
      <div id="gsiButton"></div>
    </div>

    <p class="note">
      å€‹äººã® @gmail.com ãªã©ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ã€Œæ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
      ãã®å ´åˆã¯ãƒ–ãƒ©ã‚¦ã‚¶å³ä¸Šã‹ã‚‰ <span class="domain">@katsura.com</span> ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„ã€‚
    </p>
  </main>

  <script>
    // â˜… å®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆ â˜…
    const GIS_CLIENT_ID = '306425813118-enl6g9d24jg0c68tuvp11jc4glr0efs0.apps.googleusercontent.com';
    const REDIRECT_URL  = 'https://script.google.com/a/macros/katsura.com/s/AKfycbytgABHu-l_GiaqZJHy0G87Kpr9JEFY0rXlmylS_wEW2T5QiFX1wl2gb0a68fCqmCKV/exec'; // Apps Script WebApp ã® URL
    const ALLOWED_DOMAIN = 'katsura.com';

    // IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ payload ã‚’å–ã‚Šå‡ºã™ç°¡æ˜“ãƒ˜ãƒ«ãƒ‘
    function decodeJwt(token){
      try{
        const payload = token.split('.')[1]
          .replace(/-/g, '+').replace(/_/g, '/');
        return JSON.parse(atob(payload));
      }catch(e){
        console.error('decode error', e);
        return {};
      }
    }

    function handleCredentialResponse(res){
      const token = res.credential;
      const payload = decodeJwt(token);
      const email = payload.email || '';
      const hd    = (payload.hd || '').toLowerCase();

      console.log('GIS payload:', payload);

      // hd ã§ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ã–ã£ãã‚Šãƒã‚§ãƒƒã‚¯ï¼ˆæœ¬å½“ã®åˆ¶é™ã¯ WebApp å´ã§å®Ÿæ–½ï¼‰
      if (hd !== ALLOWED_DOMAIN) {
        alert('katsura.com ã®è·å“¡ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚\nç¾åœ¨ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ: ' + (email || 'ä¸æ˜'));
        return;
      }

      // OKãªã‚‰äºˆç´„WebAppã¸é·ç§»
      window.location.href = REDIRECT_URL;
    }

    window.onload = function(){
      if (!window.google || !window.google.accounts || !window.google.accounts.id) {
        console.error('Google Identity Services ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }

      google.accounts.id.initialize({
        client_id: GIS_CLIENT_ID,
        callback: handleCredentialResponse,
        hd: ALLOWED_DOMAIN,      // UIä¸Šã¯ katsura.com ã‚’å„ªå…ˆè¡¨ç¤ºã•ã›ã‚‹ãƒ’ãƒ³ãƒˆ
        auto_select: false,
        itp_support: true
      });

      google.accounts.id.renderButton(
        document.getElementById('gsiButton'),
        {
          type: 'standard',
          theme: 'outline',
          text: 'continue_with',
          size: 'large',
          logo_alignment: 'left'
        }
      );

      // One Tap ã¯ä»Šå›ã¯ã‚ªãƒ•ã«ã—ã¦ãŠã
      // google.accounts.id.prompt();
    };
  </script>
</body>
</html>
